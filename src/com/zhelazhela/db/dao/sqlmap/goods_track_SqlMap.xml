<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="goods_track" >
  <resultMap id="ibatorgenerated_BaseResultMap" class="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="goods_id" property="goodsId" jdbcType="BIGINT" />
    <result column="visibility" property="visibility" jdbcType="INTEGER" />
    <result column="ratting" property="ratting" jdbcType="REAL" />
    <result column="SN" property="sn" jdbcType="VARCHAR" />
    <result column="trackprice" property="trackprice" jdbcType="BIT" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="goods_tag_id" property="goodsTagId" jdbcType="BIGINT" />
  </resultMap>
  <resultMap id="define_UserTrackMap" class="com.zhelazhela.db.model.define.UserTrack" >
    <result column="tag" property="tag" jdbcType="VARCHAR" />
    <result column="tag_id" property="tag_id" jdbcType="BIGINT" />
    <result column="ratting" property="ratting" jdbcType="REAL" />
    <result column="trackprice" property="trackprice" jdbcType="BIT" />
    <result column="track_time" property="track_time" jdbcType="TIMESTAMP" />
    <result column="visibility" property="visibility" jdbcType="INTEGER" />
    <result column="user_name" property="user_name" jdbcType="VARCHAR" />
    <result column="avatar" property="avatar" jdbcType="VARCHAR" />
     <result column="user_id" property="user_id" jdbcType="BIGINT" />
  </resultMap>
  <resultMap id="define_GoodsTrackMap" class="com.zhelazhela.db.model.define.UserGoods" >
    <result column="track_id" property="track_id" jdbcType="BIGINT" />
    <result column="goods_id" property="goods_id" jdbcType="BIGINT" />
    <result column="goods_sn" property="goods_sn" jdbcType="VARCHAR" />
    <result column="goods_topic" property="goods_topic" jdbcType="VARCHAR" />
    <result column="goods_pic" property="goods_pic" jdbcType="VARCHAR" />
    <result column="source" property="source" jdbcType="VARCHAR" />
    <result column="tag" property="tag" jdbcType="VARCHAR" />
    <result column="tag_id" property="tag_id" jdbcType="BIGINT" />
    <result column="track_time" property="track_time" jdbcType="TIMESTAMP" />
    <result column="gid=goods_id,gsn=goods_sn" select="goods_track.countGoodsIsTrackedByUser" property="track_user_id" />
  </resultMap>
  <sql id="ibatorgenerated_Example_Where_Clause" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    <iterate property="oredCriteria" conjunction="or" prepend="where" removeFirstPrepend="iterate" >
      <isEqual property="oredCriteria[].valid" compareValue="true" >
        (
        <iterate prepend="and" property="oredCriteria[].criteriaWithoutValue" conjunction="and" >
          $oredCriteria[].criteriaWithoutValue[]$
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithSingleValue" conjunction="and" >
          $oredCriteria[].criteriaWithSingleValue[].condition$
            #oredCriteria[].criteriaWithSingleValue[].value#
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithListValue" conjunction="and" >
          $oredCriteria[].criteriaWithListValue[].condition$
          <iterate property="oredCriteria[].criteriaWithListValue[].values" open="(" close=")" conjunction="," >
            #oredCriteria[].criteriaWithListValue[].values[]#
          </iterate>
        </iterate>
        <iterate prepend="and" property="oredCriteria[].criteriaWithBetweenValue" conjunction="and" >
          $oredCriteria[].criteriaWithBetweenValue[].condition$
          #oredCriteria[].criteriaWithBetweenValue[].values[0]# and
          #oredCriteria[].criteriaWithBetweenValue[].values[1]#
        </iterate>
        )
      </isEqual>
    </iterate>
  </sql>
  <select id="ibatorgenerated_selectByExample" resultMap="ibatorgenerated_BaseResultMap" parameterClass="com.zhelazhela.db.model.GoodsTrackExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    select id, user_id, goods_id, visibility, ratting, SN, trackprice, update_time, goods_tag_id
    from goods_track
    <isParameterPresent >
      <include refid="goods_track.ibatorgenerated_Example_Where_Clause" />
      <isNotNull property="orderByClause" >
        order by $orderByClause$
      </isNotNull>
    </isParameterPresent>
  </select>
  <select id="ibatorgenerated_selectByPrimaryKey" resultMap="ibatorgenerated_BaseResultMap" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    select id, user_id, goods_id, visibility, ratting, SN, trackprice, update_time, goods_tag_id
    from goods_track
    where id = #id:BIGINT#
  </select>
  <delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    delete from goods_track
    where id = #id:BIGINT#
  </delete>
  <delete id="ibatorgenerated_deleteByExample" parameterClass="com.zhelazhela.db.model.GoodsTrackExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    delete from goods_track
    <include refid="goods_track.ibatorgenerated_Example_Where_Clause" />
  </delete>
  <insert id="ibatorgenerated_insert" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    insert into goods_track (id, user_id, goods_id, visibility, ratting, SN, trackprice,
      update_time, goods_tag_id)
    values (#id:BIGINT#, #userId:BIGINT#, #goodsId:BIGINT#, #visibility:INTEGER#, #ratting:REAL#,
      #sn:VARCHAR#, #trackprice:BIT#, #updateTime:TIMESTAMP#, #goodsTagId:BIGINT#)
    <selectKey keyProperty="id" resultClass="java.lang.Long"> 
   		SELECT @@IDENTITY AS id 
    </selectKey>
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    insert into goods_track
    <dynamic prepend="(" >
      <isNotNull prepend="," property="id" >
        id
      </isNotNull>
      <isNotNull prepend="," property="userId" >
        user_id
      </isNotNull>
      <isNotNull prepend="," property="goodsId" >
        goods_id
      </isNotNull>
      <isNotNull prepend="," property="visibility" >
        visibility
      </isNotNull>
      <isNotNull prepend="," property="ratting" >
        ratting
      </isNotNull>
      <isNotNull prepend="," property="sn" >
        SN
      </isNotNull>
      <isNotNull prepend="," property="trackprice" >
        trackprice
      </isNotNull>
      <isNotNull prepend="," property="updateTime" >
        update_time
      </isNotNull>
      <isNotNull prepend="," property="goodsTagId" >
        goods_tag_id
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(" >
      <isNotNull prepend="," property="id" >
        #id:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="userId" >
        #userId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="goodsId" >
        #goodsId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="visibility" >
        #visibility:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="ratting" >
        #ratting:REAL#
      </isNotNull>
      <isNotNull prepend="," property="sn" >
        #sn:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="trackprice" >
        #trackprice:BIT#
      </isNotNull>
      <isNotNull prepend="," property="updateTime" >
        #updateTime:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="goodsTagId" >
        #goodsTagId:BIGINT#
      </isNotNull>
      )
    </dynamic>
    <selectKey keyProperty="id" resultClass="java.lang.Long"> 
   		SELECT @@IDENTITY AS id 
    </selectKey>
  </insert>
  <select id="ibatorgenerated_countByExample" parameterClass="com.zhelazhela.db.model.GoodsTrackExample" resultClass="java.lang.Integer" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    select count(*) from goods_track
    <include refid="goods_track.ibatorgenerated_Example_Where_Clause" />
  </select>
  <update id="ibatorgenerated_updateByExampleSelective" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    update goods_track
    <dynamic prepend="set" >
      <isNotNull prepend="," property="record.id" >
        id = #record.id:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="record.userId" >
        user_id = #record.userId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="record.goodsId" >
        goods_id = #record.goodsId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="record.visibility" >
        visibility = #record.visibility:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="record.ratting" >
        ratting = #record.ratting:REAL#
      </isNotNull>
      <isNotNull prepend="," property="record.sn" >
        SN = #record.sn:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.trackprice" >
        trackprice = #record.trackprice:BIT#
      </isNotNull>
      <isNotNull prepend="," property="record.updateTime" >
        update_time = #record.updateTime:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="record.goodsTagId" >
        goods_tag_id = #record.goodsTagId:BIGINT#
      </isNotNull>
    </dynamic>
    <isParameterPresent >
      <include refid="goods_track.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByExample" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    update goods_track
    set id = #record.id:BIGINT#,
      user_id = #record.userId:BIGINT#,
      goods_id = #record.goodsId:BIGINT#,
      visibility = #record.visibility:INTEGER#,
      ratting = #record.ratting:REAL#,
      SN = #record.sn:VARCHAR#,
      trackprice = #record.trackprice:BIT#,
      update_time = #record.updateTime:TIMESTAMP#,
      goods_tag_id = #record.goodsTagId:BIGINT#
    <isParameterPresent >
      <include refid="goods_track.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByPrimaryKeySelective" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    update goods_track
    <dynamic prepend="set" >
      <isNotNull prepend="," property="userId" >
        user_id = #userId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="goodsId" >
        goods_id = #goodsId:BIGINT#
      </isNotNull>
      <isNotNull prepend="," property="visibility" >
        visibility = #visibility:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="ratting" >
        ratting = #ratting:REAL#
      </isNotNull>
      <isNotNull prepend="," property="sn" >
        SN = #sn:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="trackprice" >
        trackprice = #trackprice:BIT#
      </isNotNull>
      <isNotNull prepend="," property="updateTime" >
        update_time = #updateTime:TIMESTAMP#
      </isNotNull>
      <isNotNull prepend="," property="goodsTagId" >
        goods_tag_id = #goodsTagId:BIGINT#
      </isNotNull>
    </dynamic>
    where id = #id:BIGINT#
  </update>
  <update id="ibatorgenerated_updateByPrimaryKey" parameterClass="com.zhelazhela.db.model.GoodsTrack" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Fri Feb 12 23:38:37 CST 2010.
    -->
    update goods_track
    set user_id = #userId:BIGINT#,
      goods_id = #goodsId:BIGINT#,
      visibility = #visibility:INTEGER#,
      ratting = #ratting:REAL#,
      SN = #sn:VARCHAR#,
      trackprice = #trackprice:BIT#,
      update_time = #updateTime:TIMESTAMP#,
      goods_tag_id = #goodsTagId:BIGINT#
    where id = #id:BIGINT#
  </update>
  
  <select id="selectUserTrackByGoods" resultMap="define_UserTrackMap" parameterClass="java.util.Map" >
    select gtag.name as tag,gtag.id as tag_id,gt.ratting,gt.trackprice,gt.update_time as track_time,gt.visibility,ui.name as user_name,ui.avatar,ui.user_id 
    from goods_track gt,userinfo ui,goods_tag gtag 
    where gt.goods_id = #goodsId:BIGINT# and (
    gt.visibility = 0
    <isNotNull prepend="or" property="user_id" >
    gt.visibility = 1
    </isNotNull>
    ) and ui.user_id = gt.user_id and gt.goods_tag_id = gtag.id
    <dynamic prepend="and">
    	 gt.user_id not in (
	    <isNotEmpty property="been_blocked">
			<iterate property="been_blocked" conjunction="," >
				$been_blocked[]$
			</iterate>  			
		</isNotEmpty>
		)
    </dynamic>
    <isNotNull property="limit">
    	limit $limit$
    </isNotNull>
  </select>
  
  <select id="countUserTrackByGoods" resultClass="java.lang.Integer" parameterClass="java.util.Map" >
    select count(ui.user_id) 
    from goods_track gt,userinfo ui,goods_tag gtag 
    where gt.goods_id = #goodsId:BIGINT# and (
    gt.visibility = 0
    <isNotNull prepend="or" property="user_id" >
    gt.visibility = 1
    </isNotNull>
    ) and ui.user_id = gt.user_id and gt.goods_tag_id = gtag.id
    <dynamic prepend="and">
    	 gt.user_id not in (
	    <isNotEmpty property="been_blocked">
			<iterate property="been_blocked" conjunction="," >
				$been_blocked[]$
			</iterate>  			
		</isNotEmpty>
		)
    </dynamic>
  </select>
  
  <select id="countGoodsIsTrackedByUser" resultClass="java.lang.Long">
  	select tmp_gt.user_id from goods_track tmp_gt 
  	where tmp_gt.goods_id= #gid# or tmp_gt.SN= #gsn#
  </select>
  
  <select id="selectUserGoodsByUser" resultMap="define_GoodsTrackMap" parameterClass="java.util.Map" >
    select gt.id as track_id,gt.goods_id as goods_id,IFNULL(gt.SN,'undefine') as goods_sn,g.topic as goods_topic,g.icon as goods_pic,g.source as source,gt.goods_tag_id as tag_id,gtg.name as tag,gt.update_time as track_time
    from goods_track gt 
    left join goods_tag gtg on gt.goods_tag_id=gtg.id 
    left join goods g on gt.goods_id=g.id or gt.SN = g.SN 
    where user_id= #user_id:BIGINT# 
    order by gt.update_time desc
    <isNotNull property="limit">
    	limit $limit$
    </isNotNull>
  </select>
  
  
</sqlMap>